---
title: "SSAC_2023"
author: "Lorenzo Dube and Xander Schwartz"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(zipcodeR)
```

#### Data Cleaning

Output of the below cell is two dataframes: 'continuous_df' which is all of the continuous data from the dataset and 'categorical_df' which is all of the categorical data.  Those with two categories have been 'one hot' encoded.

```{r Data_Clean}

cat_data_read <- function(behavior, customer) {
customer = read_csv(customer)
behavior = read_csv(behavior)

customer <- customer[, colSums(!is.na(customer)) > 0] #remove all NA only columns
customer <- customer[, !grepl("input_indv", names(customer))] #remove input_indv columns
behavior <- behavior[, colSums(!is.na(behavior)) > 0] #remove all NA only columns

df <- merge(customer, behavior, by = "acct_id")

one_hot_column_list <- sapply(df, function(x) all(is.na(x) | x %in% c(0,1)))
cont_value_column_list = !one_hot_column_list
one_hot_column_list[1] = TRUE

one_hot_df <- df[, one_hot_column_list]
one_hot_df[is.na(one_hot_df)] <- 0

cont_val_df = df[, cont_value_column_list]
cont_val_list2 <- sapply(cont_val_df, function(col) all(is.numeric(col) | is.na(col)))
cont_val_list2[1] = TRUE
continuous_df <- cont_val_df[, cont_val_list2]

other_cat_list = !cont_val_list2
other_cat_list[1] = TRUE
other_cat_df <- cont_val_df[, other_cat_list]

categorical_df = merge(one_hot_df, other_cat_df, by = 'acct_id')}


cont_data_read <- function(behavior, customer) {
customer = read_csv(customer)
behavior = read_csv(behavior)

customer <- customer[, colSums(!is.na(customer)) > 0] #remove all NA only columns
customer <- customer[, !grepl("input_indv", names(customer))] #remove input_indv columns
behavior <- behavior[, colSums(!is.na(behavior)) > 0] #remove all NA only columns

df <- merge(customer, behavior, by = "acct_id")

one_hot_column_list <- sapply(df, function(x) all(is.na(x) | x %in% c(0,1)))
cont_value_column_list = !one_hot_column_list
one_hot_column_list[1] = TRUE

one_hot_df <- df[, one_hot_column_list]
one_hot_df[is.na(one_hot_df)] <- 0

cont_val_df = df[, cont_value_column_list]
cont_val_list2 <- sapply(cont_val_df, function(col) all(is.numeric(col) | is.na(col)))
cont_val_list2[1] = TRUE
continuous_df <- cont_val_df[, cont_val_list2]}

kc_categorical= cat_data_read('KC_Behavior.csv', 'KC_Cust.csv')
kc_continuous = cont_data_read('KC_Behavior.csv', 'KC_Cust.csv')
lv_categorical = cat_data_read('Lville_Behavior.csv', 'LVille_Cust.csv')
lv_continuous = cont_data_read('Lville_Behavior.csv', 'LVille_Cust.csv')
vb_categorical = cat_data_read('VB_Behavior2.csv', 'VB_Cust.csv')
vb_continuous = cont_data_read('VB_Behavior2.csv', 'VB_Cust.csv')


```
```{r}
categorical <- lv_categorical %>% mutate(CityName = "Lousiville") %>%
  bind_rows(vb_categorical %>%  mutate(CityName = "Virginia Beach")) %>%
  bind_rows(kc_categorical %>% mutate(CityName = "Kansas City")) 

continuous <- lv_continuous %>% mutate(CityName = "Lousiville") %>%
  bind_rows(vb_continuous %>%  mutate(CityName = "Virginia Beach")) %>%
  bind_rows(kc_continuous %>% mutate(CityName = "Kansas City")) %>%
  mutate(personicx_group  = factor(case_when(psx_group_id <= 2 ~ "Youth",
                                      psx_group_id <= 8 ~ "CareerBuilding",
                                      psx_group_id <= 14 ~ "Earning",
                                      psx_group_id <= 20~ "LateCareer",
                                      psx_group_id > 20 ~ "Retired",
                                      T ~ "NA"
                                      ),ordered = T))

allData <- left_join(categorical, continuous) %>% 
  filter(brkr_ind == 0|is.na(brkr_ind))

```

Removing all accounts for which there are multiple lines for whatever reason. ~1000 observations removed. 

```{r Remove Duplicate Accts}
counts_cat <- 
  categorical %>% 
  group_by(acct_id) %>% 
  summarise(ct = n()) %>% 
  arrange(ct)

table(counts_cat$ct)

counts_cont <- 
  categorical %>%
  group_by(acct_id) %>% 
  summarise(ct = n()) %>% 
  arrange(ct)

table(counts_cont$ct)

categorical_minus_duplicates <- 
  categorical %>%
  left_join(counts_cat) %>% 
  filter(ct == 1) %>%
  select(-ct)

continuous_minus_duplicates <- 
  continuous %>%
  left_join(counts_cont) %>% 
  filter(ct == 1) %>%
  select(-ct)
```

### Zip Codes

Hardcoding roughly where we expect the stadiums to be built

```{r Hardcode Zips}
kc_zip <- 64129 #arrowhead
vb_zip <- 23456 #vb sports complex
lville_zip <- 40208 #cardinal stadium 
```

```{r Zip Diagnostics}
ggplot(continuous, aes(x= cust_postal_cd )) + 
  geom_histogram() +
  facet_wrap(~CityName) + 
  labs(x = "Zip Code")
```

# Where are different types of fans


```{r}
population <- data.frame (city  = c("Virginia Beach", "Lousiville", "Kansas City"),
                  population = c(1800000, 1400000, 2200000))

fan_types <-
  continuous %>% 
  select(contains("propn_score_minor_4"), CityName) %>% 
  pivot_longer(values_to = "score", cols = c(contains("propn")), names_to = "Prop") %>%
  left_join(population, by = c("CityName" = "city"))%>%
  left_join(read_csv("prop_join.csv")) %>%
  mutate(prop_number = as.numeric(substring(Prop,nchar(Prop)-3+1), nchar(Prop))) %>%
  filter(between(prop_number, 410, 450)) %>% 
  mutate(super_fan = ifelse(score >= 650, 1, 0),
         regular_fan= ifelse(score >= mean(score, na.rm=T), 1, 0),
         Sport = sub(".*:", "", Sport))

fan_totals <-
  fan_types %>% 
  group_by(CityName) %>% 
  summarise(city_fan_ct = n())

fan_types_by_city <- 
  fan_types %>% 
  group_by(CityName, Sport) %>%
  summarise(population = mean(population),
            avg_score = mean(score, na.rm=T),
            regular_fans =  sum(regular_fan, na.rm=T), 
            super_fans = sum(super_fan, na.rm=T),
            ct = n(),
            expected_super_fans = super_fans*population/ct,
            expected_regular_fans = regular_fans*population/ct,
            ) %>%
  left_join(fan_totals) %>% 
  rowwise() %>%
  mutate(perc_by_sport = ct/city_fan_ct)


  

ggplot(fan_types_by_city, aes(x= Sport, y = expected_regular_fans/1000, fill = Sport)) + 
  geom_col() +
  facet_wrap(~CityName)+
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Sport", y = "Expected Thousands of Regular Fans", title = "Regular Fans by City and Sport")

ggplot(fan_types_by_city, aes(x= Sport, y = expected_super_fans/1000, fill = Sport)) + 
  geom_col() +
  facet_wrap(~CityName)+
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Sport", y = "Expected Thousands of Super Fans", title = "Super Fans by Ciry and Sport")
```



```{r}

percentFans <- fan_types_by_city %>% grou
```


