---
title: "SSAC_2023"
author: "Lorenzo Dube and Xander Schwartz"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(zipcodeR)
```

#### Data Cleaning

Output of the below cell is two dataframes: 'continuous_df' which is all of the continuous data from the dataset and 'categorical_df' which is all of the categorical data.  Those with two categories have been 'one hot' encoded.

```{r Data_Clean}

cat_data_read <- function(behavior, customer) {
customer = read_csv(customer)
behavior = read_csv(behavior)

customer <- customer[, colSums(!is.na(customer)) > 0] #remove all NA only columns
customer <- customer[, !grepl("input_indv", names(customer))] #remove input_indv columns
behavior <- behavior[, colSums(!is.na(behavior)) > 0] #remove all NA only columns

df <- merge(customer, behavior, by = "acct_id")

one_hot_column_list <- sapply(df, function(x) all(is.na(x) | x %in% c(0,1)))
cont_value_column_list = !one_hot_column_list
one_hot_column_list[1] = TRUE

one_hot_df <- df[, one_hot_column_list]
one_hot_df[is.na(one_hot_df)] <- 0

cont_val_df = df[, cont_value_column_list]
cont_val_list2 <- sapply(cont_val_df, function(col) all(is.numeric(col) | is.na(col)))
cont_val_list2[1] = TRUE
continuous_df <- cont_val_df[, cont_val_list2]

other_cat_list = !cont_val_list2
other_cat_list[1] = TRUE
other_cat_df <- cont_val_df[, other_cat_list]

categorical_df = merge(one_hot_df, other_cat_df, by = 'acct_id')}


cont_data_read <- function(behavior, customer) {
customer = read_csv(customer)
behavior = read_csv(behavior)

customer <- customer[, colSums(!is.na(customer)) > 0] #remove all NA only columns
customer <- customer[, !grepl("input_indv", names(customer))] #remove input_indv columns
behavior <- behavior[, colSums(!is.na(behavior)) > 0] #remove all NA only columns

df <- merge(customer, behavior, by = "acct_id")

one_hot_column_list <- sapply(df, function(x) all(is.na(x) | x %in% c(0,1)))
cont_value_column_list = !one_hot_column_list
one_hot_column_list[1] = TRUE

one_hot_df <- df[, one_hot_column_list]
one_hot_df[is.na(one_hot_df)] <- 0

cont_val_df = df[, cont_value_column_list]
cont_val_list2 <- sapply(cont_val_df, function(col) all(is.numeric(col) | is.na(col)))
cont_val_list2[1] = TRUE
continuous_df <- cont_val_df[, cont_val_list2]}

kc_categorical= cat_data_read('KC_Behavior.csv', 'KC_Cust.csv')
kc_continuous = cont_data_read('KC_Behavior.csv', 'KC_Cust.csv')
lv_categorical = cat_data_read('Lville_Behavior.csv', 'LVille_Cust.csv')
lv_continuous = cont_data_read('Lville_Behavior.csv', 'LVille_Cust.csv')
vb_categorical = cat_data_read('VB_Behavior2.csv', 'VB_Cust.csv')
vb_continuous = cont_data_read('VB_Behavior2.csv', 'VB_Cust.csv')


```
```{r}
categorical <- lv_categorical %>% mutate(CityName = "Lousiville") %>%
  bind_rows(vb_categorical %>%  mutate(CityName = "Virginia Beach")) %>%
  bind_rows(kc_categorical %>% mutate(CityName = "Kansas City")) 

continuous <- lv_continuous %>% mutate(CityName = "Lousiville") %>%
  bind_rows(vb_continuous %>%  mutate(CityName = "Virginia Beach")) %>%
  bind_rows(kc_continuous %>% mutate(CityName = "Kansas City"))
```

Removing all accounts for which there are multiple lines for whatever reason. ~1000 observations removed. 

```{r Remove Duplicate Accts}
counts_cat <- 
  categorical %>% 
  group_by(acct_id) %>% 
  summarise(ct = n()) %>% 
  arrange(ct)

table(counts_cat$ct)

counts_cont <- 
  categorical %>%
  group_by(acct_id) %>% 
  summarise(ct = n()) %>% 
  arrange(ct)

table(counts_cont$ct)

categorical_minus_duplicates <- 
  categorical %>%
  left_join(counts_cat) %>% 
  filter(ct == 1) %>%
  select(-ct)

continuous_minus_duplicates <- 
  continuous %>%
  left_join(counts_cont) %>% 
  filter(ct == 1) %>%
  select(-ct)
```

### Zip Codes

Hardcoding roughly where we expect the stadiums to be built

```{r}
kc_zip <- 64129 #arrowhead
vb_zip <- 23456 #vb sports complex
lville_zip <- 40208 #cardinal stadium 
```

```{r Zip Diagnostics}
ggplot(continuous, aes(x= cust_postal_cd )) + 
  geom_histogram() +
  facet_wrap(~CityName) + 
  labs(x = "Zip Code")
```
